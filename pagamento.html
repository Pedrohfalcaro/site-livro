const express = require("express");
const multer = require("multer");
const cors = require("cors");
const fs = require("fs");
const { Resend } = require("resend");

const app = express();
const port = process.env.PORT || 3000;

const resend = new Resend(process.env.RESEND_API_KEY);

// ‚úÖ Parse JSON (IMPORTANTE pro webhook)
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ‚úÖ CORS (pro seu front do GitHub Pages)
app.use(
  cors({
    origin: "https://pedrohfalcaro.github.io",
    methods: ["GET", "POST", "OPTIONS"],
    allowedHeaders: ["Content-Type"],
  })
);

// ===== Health check =====
app.get("/health", (req, res) => res.status(200).send("OK"));

// =========================
// ‚úÖ MERCADO PAGO
// =========================
const SITE_URL = "https://pedrohfalcaro.github.io";
const API_URL = "https://site-livro-backend.onrender.com";
const MP_TOKEN = process.env.MP_ACCESS_TOKEN;

// Cria prefer√™ncia do Checkout Pro
app.post("/mp/preferencia", async (req, res) => {
  try {
    if (!MP_TOKEN) return res.status(500).json({ ok: false, error: "MP_ACCESS_TOKEN ausente no Render" });

    const { nome, email, itens } = req.body;

    const preference = {
      items: (itens || []).map((i) => ({
        title: i.title,
        quantity: Number(i.quantity || 1),
        unit_price: Number(i.unit_price),
        currency_id: "BRL",
      })),
      payer: { name: nome, email },
      back_urls: {
        success: `${SITE_URL}/Site-Estante-de-Historias/pagamento-sucesso.html`,
        failure: `${SITE_URL}/Site-Estante-de-Historias/pagamento-erro.html`,
        pending: `${SITE_URL}/Site-Estante-de-Historias/pagamento-pendente.html`,
      },
      auto_return: "approved",
      notification_url: `${API_URL}/mp/webhook`,
      metadata: { nome, email },
    };

    const r = await fetch("https://api.mercadopago.com/checkout/preferences", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${MP_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(preference),
    });

    const data = await r.json();
    if (!r.ok) return res.status(400).json({ ok: false, error: data });

    return res.json({ ok: true, preference_id: data.id, init_point: data.init_point });
  } catch (e) {
    console.error("MP preferencia erro:", e);
    res.status(500).json({ ok: false, error: "Erro ao criar prefer√™ncia" });
  }
});

// ‚úÖ Webhook: aceita GET/POST/HEAD (para o teste do painel n√£o dar 404)
app.all("/mp/webhook", async (req, res) => {
  // responda 200 IMEDIATO (MP precisa disso)
  res.sendStatus(200);

  try {
    if (!MP_TOKEN) return;

    console.log("Webhook MP recebido:", req.method, req.body);

    const paymentId = req.body?.data?.id || req.query?.id;
    if (!paymentId) return;

    const r = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
      headers: { Authorization: `Bearer ${MP_TOKEN}` },
    });

    const payment = await r.json();
    if (!r.ok) return;

    console.log("Pagamento status:", payment.status, "id:", payment.id);

    if (payment.status === "approved") {
      // aqui depois a gente liga: enviar email, salvar pedido etc.
      console.log("‚úÖ Pagamento aprovado:", payment.id, payment.transaction_amount);
    }
  } catch (e) {
    console.error("Webhook erro:", e);
  }
});

// =========================
// ‚úÖ SEU FLUXO PIX COM COMPROVANTE (mantido)
// =========================

// Multer upload
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, "uploads/"),
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname),
});
const upload = multer({ storage });

if (!fs.existsSync("uploads")) fs.mkdirSync("uploads");

app.post("/enviar-pagamento", upload.single("comprovante"), async (req, res) => {
  const { nome, email, rua, numero, bairro, cidade, estado, cep, resumo } = req.body;
  const comprovante = req.file;

  if (!comprovante) {
    return res.status(400).json({ sucesso: false, erro: "Comprovante n√£o recebido." });
  }

  const endereco = `${rua}, ${numero} - ${bairro}, ${cidade} - ${estado}, CEP: ${cep}`;

  try {
    await resend.emails.send({
      from: "Pedidos <onboarding@resend.dev>",
      to: "pedrofalcari@gmail.com",
      subject: `üìö Novo Pedido de ${nome}`,
      text: `Nome: ${nome}\nEmail: ${email}\nEndere√ßo: ${endereco}\n\nLivros:\n${resumo}\n\n‚úîÔ∏è Comprovante em anexo.`,
      attachments: [
        {
          filename: comprovante.originalname,
          content: fs.readFileSync(comprovante.path).toString("base64"),
          type: comprovante.mimetype,
        },
      ],
    });

    await resend.emails.send({
      from: "Estante de Hist√≥rias <no-reply@estantedehistorias.com>",
      to: email,
      subject: "üìñ Pedido Recebido com Sucesso!",
      text: `Ol√°, ${nome}!\n\nSeu pedido foi recebido com sucesso! üéâüì¶\n\nüìö Resumo:\n${resumo}\n\nEm breve voc√™ receber√° mais informa√ß√µes.\n\nCom carinho,\nPedro Henrique`,
    });

    res.json({ sucesso: true });
  } catch (error) {
    console.error("Erro ao enviar e-mails:", error);
    res.status(500).json({ sucesso: false, erro: error.message });
  }
});

// ‚úÖ por √∫ltimo: iniciar servidor
app.listen(port, () => console.log(`Servidor rodando na porta ${port}`));
