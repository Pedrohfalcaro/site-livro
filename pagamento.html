<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" type="image/png" href="imagens/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pagamento ‚Äî Estante de Hist√≥rias</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <meta property="og:title" content="Pagamento ‚Äî Estante de Hist√≥rias" />
  <meta property="og:description" content="Finalize sua compra com Pix ou cart√£o via Mercado Pago." />
  <meta property="og:image" content="imagens/favicon.png" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="pt_BR" />

  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --muted2:#64748b;
      --border:#e2e8f0; --accent:#14b8a6; --accent2:#0ea5e9;
      --shadow2:0 8px 18px rgba(15,23,42,.08); --radius:18px;
    }
    body{ background:var(--bg); color:var(--text); }

    body.dark-mode{
      --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#cbd5e1; --muted2:#9ca3af;
      --border:#263244; --accent:#34d399; --accent2:#38bdf8;
      --shadow2:0 10px 22px rgba(0,0,0,.35);
    }

    .surface{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow2); }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      border-radius:9999px; padding:.75rem 1.1rem; font-weight:800;
      transition:.15s ease; user-select:none;
    }
    .btn-primary{ background:var(--accent); color:#fff; }
    .btn-primary:hover{ opacity:.95; }
    .btn-ghost{ background:transparent; border:1px solid var(--border); color:var(--text); }
    .btn-ghost:hover{ background:rgba(15,23,42,.05); }
    body.dark-mode .btn-ghost:hover{ background:rgba(255,255,255,.06); }

    .glass{ background:rgba(255,255,255,.85); backdrop-filter:blur(10px); border-bottom:1px solid var(--border); }
    body.dark-mode .glass{ background:rgba(11,18,32,.7); }

    .theme-dot{
      width:22px; height:22px; border-radius:9999px; cursor:pointer;
      border:1px solid var(--border);
    }
    #temaClaro { background:linear-gradient(90deg,#fff 50%, #14b8a6 50%); }
    #temaEscuro{ background:linear-gradient(90deg,#0b1220 50%, #38bdf8 50%); }

    .field{
      width:100%;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:9999px;
      padding:.85rem 1.05rem;
      color:var(--text);
      outline:none;
    }
    .field:focus{
      border-color: rgba(20,184,166,.55);
      box-shadow: 0 0 0 4px rgba(20,184,166,.14);
    }

    .chip{
      display:inline-flex; align-items:center; gap:.5rem;
      border:1px solid var(--border);
      border-radius:9999px;
      padding:.55rem .9rem;
      font-weight:800;
      font-size:.875rem;
      background:transparent;
      color:var(--text);
    }

    .toast{
      position:fixed;
      top:84px;
      right:18px;
      z-index:60;
      padding:.85rem 1rem;
      border-radius:16px;
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow2);
      display:none;
      max-width:min(420px, calc(100vw - 36px));
    }
    .toast.show{ display:block; }

    .note{
      border:1px dashed var(--border);
      border-radius:16px;
      padding:1rem;
      background: rgba(14,165,233,.06);
    }
    body.dark-mode .note{ background: rgba(56,189,248,.10); }

    .danger{
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.25);
      color: #b91c1c;
      border-radius: 16px;
      padding: .9rem 1rem;
    }
    body.dark-mode .danger{
      color:#fecaca;
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
    }
  </style>
</head>

<body class="font-sans min-h-screen">

  <!-- Toasts -->
  <div id="toastWait" class="toast">
    <div class="flex items-start gap-2">
      <span>‚è≥</span>
      <div>
        <p class="font-extrabold leading-tight">Iniciando pagamento‚Ä¶</p>
        <p class="text-sm muted2 mt-1">Voc√™ ser√° encaminhado ao Mercado Pago (Pix ou cart√£o).</p>
      </div>
    </div>
  </div>

  <div id="toastErr" class="toast">
    <div class="flex items-start gap-2">
      <span>‚ö†Ô∏è</span>
      <div>
        <p class="font-extrabold leading-tight">N√£o foi poss√≠vel iniciar</p>
        <p class="text-sm muted2 mt-1">Tente novamente em instantes.</p>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="glass sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <a href="index.html" class="inline-flex items-center gap-2">
          <img src="imagens/LogoSite.png" class="h-9" alt="Logo">
        </a>

        <button id="temaClaro" class="theme-dot" title="Tema claro" aria-label="Tema claro"></button>
        <button id="temaEscuro" class="theme-dot" title="Tema escuro" aria-label="Tema escuro"></button>
      </div>

      <div class="hidden md:flex items-center gap-2">
        <a href="index.html" class="btn btn-ghost">In√≠cio</a>
        <a href="loja.html" class="btn btn-ghost">Loja</a>
        <a href="sobreautor.html" class="btn btn-ghost">Sobre</a>
        <a href="contos.html" class="btn btn-ghost">Contos</a>
      </div>

      <a href="loja.html" class="btn btn-primary">Voltar pra loja</a>
    </div>

    <div class="md:hidden max-w-6xl mx-auto px-4 pb-3">
      <div class="flex flex-wrap gap-2">
        <a href="index.html" class="btn btn-ghost !py-2">In√≠cio</a>
        <a href="loja.html" class="btn btn-ghost !py-2">Loja</a>
        <a href="sobreautor.html" class="btn btn-ghost !py-2">Sobre</a>
        <a href="contos.html" class="btn btn-ghost !py-2">Contos</a>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="max-w-6xl mx-auto px-4 pt-8">
    <div class="surface p-6 sm:p-8">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div>
          <span class="chip" style="background: rgba(20,184,166,.10); border-color: rgba(20,184,166,.22); color: var(--accent);">
            ‚úÖ Pagamento
          </span>
          <h1 class="mt-3 text-2xl sm:text-3xl font-extrabold">Finalizar compra</h1>
          <p class="mt-2 muted">
            Preencha seus dados. Voc√™ poder√° pagar com <strong>Pix ou cart√£o</strong> via Mercado Pago.
          </p>
        </div>

        <div class="note w-full md:max-w-[420px]">
          <p class="font-extrabold">Resumo do pedido</p>
          <p id="resumoTop" class="text-sm muted2 mt-1">Carregando‚Ä¶</p>
          <div class="mt-3 flex items-center gap-2">
            <button class="btn btn-ghost !py-2" onclick="limparSacola()">Limpar sacola</button>
            <button class="btn btn-ghost !py-2" onclick="verItens()">Ver itens</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-10">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- FORM -->
      <section class="surface p-6 sm:p-8 lg:col-span-2">
        <h2 class="text-xl font-extrabold">Seus dados</h2>
        <p class="text-sm muted2 mt-1">Obrigat√≥rio: nome, e-mail, CPF e endere√ßo completo (para envio de livro f√≠sico).</p>

        <div id="alertaVazio" class="hidden danger mt-5">
          Sua sacola est√° vazia. Volte para a loja e adicione um item antes de pagar.
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label class="block text-sm font-extrabold mb-2">Seu nome completo</label>
            <input id="nome" class="field" placeholder="Nome completo" autocomplete="name" />
          </div>

          <div class="sm:col-span-2">
            <label class="block text-sm font-extrabold mb-2">Seu e-mail</label>
            <input id="email" type="email" class="field" placeholder="exemplo@dominio.com" autocomplete="email" />
          </div>

          <div class="sm:col-span-2">
            <label class="block text-sm font-extrabold mb-2">CPF</label>
            <input id="cpf" class="field" placeholder="000.000.000-00" inputmode="numeric" />
            <p class="text-xs muted2 mt-2">Usado para identifica√ß√£o do pedido e emiss√£o/registro, se necess√°rio.</p>
          </div>

          <div class="sm:col-span-2">
            <label class="block text-sm font-extrabold mb-2">Rua</label>
            <input id="rua" class="field" placeholder="Rua" autocomplete="address-line1" />
          </div>

          <div>
            <label class="block text-sm font-extrabold mb-2">N√∫mero</label>
            <input id="numero" class="field" placeholder="N√∫mero" autocomplete="address-line2" />
          </div>

          <div>
            <label class="block text-sm font-extrabold mb-2">Bairro</label>
            <input id="bairro" class="field" placeholder="Bairro" autocomplete="address-level3" />
          </div>

          <div class="sm:col-span-1">
            <label class="block text-sm font-extrabold mb-2">Cidade</label>
            <input id="cidade" class="field" placeholder="Cidade" autocomplete="address-level2" />
          </div>

          <div class="sm:col-span-1">
            <label class="block text-sm font-extrabold mb-2">Estado</label>
            <input id="estado" class="field" placeholder="UF" autocomplete="address-level1" />
          </div>

          <div class="sm:col-span-2">
            <label class="block text-sm font-extrabold mb-2">CEP</label>
            <input id="cep" class="field" placeholder="00000-000" inputmode="numeric" autocomplete="postal-code" />
          </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-3">
          <button id="btnPagar" onclick="pagarMercadoPago()" class="btn btn-primary w-full sm:w-auto">
            üí≥ Pagar com Mercado Pago (Pix ou Cart√£o)
          </button>
          <a href="loja.html" class="btn btn-ghost w-full sm:w-auto">Voltar pra loja</a>
        </div>

        <p class="mt-5 text-sm muted2">
          Ap√≥s o pagamento aprovado, voc√™ receber√° confirma√ß√£o por e-mail.
        </p>
      </section>

      <!-- RESUMO DETALHADO -->
      <aside class="surface p-6 sm:p-8">
        <h2 class="text-xl font-extrabold">Itens</h2>
        <p class="text-sm muted2 mt-1">Confira antes de pagar.</p>

        <div class="mt-4">
          <div id="listaItens" class="mt-3 space-y-3"></div>

          <div class="mt-6 pt-4 border-t" style="border-color:var(--border)">
            <div class="flex items-center justify-between">
              <span class="font-extrabold">Total</span>
              <span id="totalValor" class="text-lg font-extrabold" style="color:var(--accent2)">R$ 0,00</span>
            </div>
          </div>

          <div class="mt-5 note">
            <p class="font-extrabold">Entrega / Acesso</p>
            <p class="text-sm muted2 mt-1">
              WebLivros: voc√™ recebe a chave por e-mail.<br>
              Livros f√≠sicos: envio para o endere√ßo informado.
            </p>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10">
    <div class="surface p-6 sm:p-8 flex flex-col sm:flex-row gap-4 sm:items-center sm:justify-between">
      <div>
        <h3 class="text-lg font-extrabold">Contato</h3>
        <p class="text-sm muted2">Se tiver qualquer problema, fale comigo por e-mail:</p>
      </div>
      <a href="mailto:pedrofalcari@gmail.com" class="btn btn-ghost w-full sm:w-auto">pedrofalcari@gmail.com</a>
    </div>
  </footer>

<script>
/* ===== Tema ===== */
(function(){
  const KEY='theme';
  const b=document.body;
  function apply(t){ b.classList.toggle('dark-mode', t==='dark'); }
  apply(localStorage.getItem(KEY)||'light');
  temaClaro.onclick=()=>{ localStorage.setItem(KEY,'light'); apply('light'); }
  temaEscuro.onclick=()=>{ localStorage.setItem(KEY,'dark');  apply('dark');  }
})();

/* ===== Util ===== */
function brl(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

function showToast(id, ms=2500){
  const t=document.getElementById(id);
  if(!t) return;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.classList.remove('show'), ms);
}

/* ===== Sacola ===== */
function getEstante(){
  return JSON.parse(localStorage.getItem('estante')||'[]');
}

function renderResumo(){
  const estante=getEstante();
  const totalItens=estante.reduce((s,x)=>s+x.quantidade,0);
  const totalValor=estante.reduce((s,x)=>s+(x.preco*x.quantidade),0);

  document.getElementById('resumoTop').innerHTML =
    `üìö <strong>${totalItens}</strong> item(ns) ‚Ä¢ üí∞ <strong>${brl(totalValor)}</strong>`;

  document.getElementById('totalValor').textContent = brl(totalValor);

  const lista=document.getElementById('listaItens');
  if(estante.length===0){
    lista.innerHTML = `
      <div class="text-center py-6">
        <div class="text-4xl mb-2">üì≠</div>
        <p class="font-extrabold">Sacola vazia</p>
        <p class="text-sm muted2 mt-1">Volte para a loja e adicione um item.</p>
      </div>
    `;
    return;
  }

  lista.innerHTML = estante.map(x=>`
    <div class="border rounded-2xl p-3" style="border-color:var(--border)">
      <p class="font-extrabold text-sm">${x.nome}</p>
      <p class="text-xs muted2 mt-1">${x.quantidade}√ó ‚Ä¢ ${brl(x.preco)} (un.)</p>
      <p class="text-sm font-extrabold mt-2">${brl(x.preco*x.quantidade)}</p>
    </div>
  `).join('');
}

function limparSacola(){
  localStorage.removeItem('estante');
  renderResumo();
  validarSacolaVazia();
}

function verItens(){
  const el=document.getElementById('listaItens');
  el?.scrollIntoView({behavior:'smooth', block:'start'});
}

function validarSacolaVazia(){
  const estante=getEstante();
  const alerta=document.getElementById('alertaVazio');
  alerta.classList.toggle('hidden', estante.length!==0);

  const btn=document.getElementById('btnPagar');
  btn.disabled = (estante.length===0);
  btn.style.opacity = (estante.length===0) ? '.6' : '1';
}

function onlyDigits(s){ return (s||"").replace(/\D/g,''); }

/* ===== Mercado Pago ===== */
async function pagarMercadoPago(){
  const estante = getEstante();
  if(estante.length===0){
    validarSacolaVazia();
    return;
  }

  const nome = (document.getElementById("nome").value || "").trim();
  const email = (document.getElementById("email").value || "").trim();
  const cpf = (document.getElementById("cpf").value || "").trim();

  const rua = (document.getElementById("rua").value || "").trim();
  const numero = (document.getElementById("numero").value || "").trim();
  const bairro = (document.getElementById("bairro").value || "").trim();
  const cidade = (document.getElementById("cidade").value || "").trim();
  const estado = (document.getElementById("estado").value || "").trim();
  const cep = (document.getElementById("cep").value || "").trim();

  if(!nome || !email || !cpf || !rua || !numero || !bairro || !cidade || !estado || !cep){
    alert("Preencha nome, e-mail, CPF e endere√ßo completo antes de pagar.");
    return;
  }

  // Itens para o backend (MVP: usando dados da sacola)
  const itens = estante.map(x => ({
    title: x.nome,
    unit_price: Number(x.preco),
    quantity: Number(x.quantidade || 1)
  }));

  const payload = {
    nome,
    email,
    cpf: onlyDigits(cpf),
    endereco: {
      rua, numero, bairro, cidade, estado,
      cep: onlyDigits(cep)
    },
    itens
  };

  const btn = document.getElementById('btnPagar');
  btn.disabled = true;
  btn.style.opacity = '.7';
  showToast('toastWait', 15000);

  try{
    const r = await fetch("https://site-livro-backend.onrender.com/mp/preferencia", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await r.json();

    if(r.ok && data.ok && data.init_point){
      // redireciona para Mercado Pago (Pix ou cart√£o)
      window.location.href = data.init_point;
      return;
    }

    console.log("Erro preferencia:", data);
    showToast('toastErr', 3000);
    alert("N√£o foi poss√≠vel iniciar o pagamento. Tente novamente.");
  } catch(err){
    console.error(err);
    showToast('toastErr', 3000);
    alert("Erro ao iniciar pagamento. Verifique sua internet e tente novamente.");
  } finally{
    btn.disabled = false;
    btn.style.opacity = '1';
  }
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  renderResumo();
  validarSacolaVazia();
});
</script>

</body>
</html>
